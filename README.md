# 镁合金温度预测项目

## 项目简介

本项目基于深度学习技术，使用图像处理和混合模型对镁合金的温度进行预测。主要通过分析镁合金图像的颜色特征和纹理特征，实现温度回归任务。

## main03.py - 主训练脚本

### 数据清洗过程

1. **图像读取与预处理**：
   - 使用OpenCV读取图像文件，支持多种格式（jpg, jpeg, png, tif, tiff, bmp）
   - 将图像从BGR转换为RGB，然后转换为Lab颜色空间
   - 分离L、a、b三个通道进行处理

2. **图像清洗**：
   - **全局亮度对齐**：计算L通道的中位数，将其调整到128（Lab空间的标准亮度），确保图像亮度一致性
   - **去噪处理**：对a和b通道应用高斯模糊（5x5内核），减少噪声干扰

3. **特征提取**：
   - **颜色直方图**：分别计算a和b通道的32-bin直方图，进行归一化，得到64维特征向量
   - **基本统计特征**：实时计算图像的均值、标准差等统计信息

### 模型构建

采用混合神经网络架构，结合卷积神经网络（CNN）和统计特征：

1. **CNN分支**：
   - 基于ResNet18预训练模型，提取图像的深度特征
   - 添加SE（Squeeze-and-Excitation）注意力模块，增强特征表达能力
   - 输出512维特征向量

2. **统计特征分支**：
   - 输入包括8维基本统计特征（各通道均值、标准差、a-b差值、a+b和）加上64维直方图特征，共72维
   - 通过全连接层压缩到64维

3. **特征融合**：
   - 将CNN特征（512维）和统计特征（64维）拼接，输入回归头
   - 回归头包含两层全连接层和Dropout，最终输出温度预测值

### 模型训练

1. **数据准备**：
   - 数据集随机分割为训练集（80%）和测试集（20%）
   - 训练集应用数据增强：随机水平/垂直翻转、随机旋转（±10°）
   - 使用DataLoader，批次大小16

2. **训练配置**：
   - 损失函数：SmoothL1Loss（Huber损失的变体，对异常值更鲁棒）
   - 优化器：Adam，初始学习率0.0005
   - 学习率调度：余弦退火调度器，从0.0005衰减到1e-6
   - 训练轮数：200 epochs

3. **训练过程**：
   - 监控训练损失和测试MAE（平均绝对误差）
   - 保存验证集上MAE最小的模型权重
   - 最终模型保存为`magnesium_hybrid_hist_model.pth`

## 其他文件说明

### predict.py
预测脚本，用于加载训练好的模型对新图像进行温度预测。重新定义了模型结构以匹配训练时的架构。

### ttransform.py
图像文件重命名工具，将格式为`xx-yy.tiff`的图像重命名为`G_xx_yy.tiff`，用于数据预处理。

### 模型权重文件


## 环境要求

- Python 3.7+
- PyTorch 1.7+
- OpenCV
- NumPy, Matplotlib, PIL
- torchvision

## 使用方法

1. 准备数据：将镁合金图像放置在指定目录，文件名格式应包含温度信息（如`sample_300.jpg`表示300°C）
2. 运行训练：`python main03.py`
3. 进行预测：修改`predict.py`中的路径和模型文件，运行`python predict.py`
