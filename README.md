# 镁合金温度预测项目

## 项目简介

本项目基于深度学习技术，使用图像处理和混合模型对镁合金的温度进行预测。主要通过分析镁合金图像的颜色特征和统计特征，采用HybridResNet混合神经网络架构实现温度回归任务。

## main03.py - 主训练脚本

### 数据清洗与预处理

1. **图像读取**：
   - 使用OpenCV读取图像文件，支持多种格式（jpg, jpeg, png, tif, tiff, bmp）
   - 使用`np.fromfile`和`cv2.imdecode`确保正确处理各种编码

2. **颜色空间转换**：
   - BGR → RGB → Lab色彩空间
   - 分离L、a、b三个通道进行独立处理

3. **图像清洗策略**：
   - **反光点去除**：检测L通道中亮度 > 中位数+70的像素，替换为中位数值
   - **全局亮度对齐**：计算L通道中位数，将其调整到128（Lab空间标准亮度），确保不同图像亮度一致性
   - **降噪处理**：对a、b通道应用高斯模糊（5×5内核），减少色彩噪声

4. **特征提取**：
   - **颜色直方图**（64维）：分别计算a、b通道的32-bin直方图并归一化
   - **基本统计特征**（8维）：实时计算三个通道的均值、标准差，以及a-b差值、a+b和

### 模型架构 (HybridResNet)

采用两分支融合的混合神经网络架构：

1. **CNN分支**：
   - 基础网络：ResNet18（预训练权重）
   - 特征提取：去掉分类头，保留卷积层
   - 注意力机制：SE Block（通道注意力）在最后一个残差块后
   - 全局平均池化：输出512维特征向量

2. **统计特征分支**：
   - **输入维度**：8维（基本统计）+ 64维（颜色直方图）= 72维
   - **处理流程**：
     ```
     72维 → Linear(72→64) → ReLU → BatchNorm1d(64) → 64维输出
     ```

3. **特征融合与回归**：
   - 将CNN特征（512维）和统计特征（64维）在通道维度拼接（共576维）
   - 回归头结构：
     ```
     576维 → Linear(576→128) → ReLU → Dropout(0.2) → Linear(128→1)
     ```
   - 输出：单个回归值（标准化的温度值）

### 数据处理

1. **标签标准化**：
   - 原始温度 T → 标准化：`label = (T - 250.0) / 200.0`
   - 预测时反标准化：`T_pred = output * 200.0 + 250.0`
   - 标准化范围覆盖 250°C 到 450°C

2. **数据增强**（仅训练集）：
   - 随机水平翻转（概率0.5）
   - 随机垂直翻转（概率0.5）
   - 随机旋转（±10°范围内）
   - 图像尺寸统一为 224×224

3. **数据集分割**：
   - 训练集：80%，应用数据增强
   - 测试集：20%，不应用数据增强
   - 批次大小：16

### 训练配置

- **损失函数**：SmoothL1Loss（对异常值更鲁棒，适合回归任务）
- **优化器**：Adam，初始学习率 0.0005
- **学习率调度**：CosineAnnealingLR，余弦退火策略
  - T_max = 200（总epoch数）
  - eta_min = 1e-6（最小学习率）
- **训练轮数**：200 epochs
- **评估指标**：MAE（平均绝对误差），单位°C
- **模型保存**：保留验证集MAE最小的模型权重

### 训练工作流

```
1. 加载数据 → 2. 前向传播(CNN + Stats) → 3. 计算损失
                                    ↓
4. 反向传播 → 5. 更新权重 → 6. 学习率衰减
                  ↓
7. 评估（计算测试MAE）→ 8. 保存最优模型
```

## 文件说明

| 文件 | 说明 |
|------|------|
| `main03.py` | 主训练脚本，包含数据加载、模型定义、训练流程 |
| `predict.py` | 预测脚本，加载模型对新图像进行温度预测 |
| `ttransform.py` | 文件重命名工具，用于数据预处理 |
| `magnesium_hybrid_hist_model.pth` | 训练好的模型权重 |
| `best_magnesium_model.pth` | 最佳性能模型权重 |

## 环境要求

```
Python 3.7+
PyTorch >= 1.7.0
OpenCV (cv2)
NumPy
Matplotlib
torchvision
```

## 使用方法

### 1. 数据准备
- 将镁合金图像放置在指定目录
- 文件名格式：`G{组号}_{温度}.jpg`，例如：`G3_350.jpg`（G3组，350°C）
- 修改 main03.py 中的 `data_dir` 为实际路径

### 2. 运行训练
```bash
python main03.py
```

### 3. 进行预测
```bash
python predict.py
```
修改文件中的模型路径和输入图像路径

## 模型性能

- 训练数据：镁合金高温氧化图像
- 输出范围：250°C - 450°C
- 评估指标：MAE（平均绝对误差，单位°C）

============================================================
🏁 训练完成
   用时: 70分 19秒
   最终最佳测试 MAE: 4.03℃

💾 模型已保存到: optimized_final_model.pth

============================================================
📊 最终结果详细分析
============================================================

🎯 总体指标:
  平均绝对误差 (MAE): 4.94℃
  均方根误差 (RMSE): 6.54℃

🌡️  分温度区间:
  低温(250-300℃): 20样本, MAE:  5.94℃, STD:  5.05℃
  中低温(300-350℃): 20样本, MAE:  2.15℃, STD:  2.96℃
  中温(350-400℃): 20样本, MAE:  2.99℃, STD:  3.24℃
  高温(400-450℃): 20样本, MAE:  7.66℃, STD:  4.30℃

📈 误差分布分析:
  误差 ≤ 1℃:  24.4%
  误差 ≤ 2℃:  36.6%
  误差 ≤ 3℃:  42.7%
  误差 ≤ 4℃:  50.0%
  误差 ≤ 5℃:  59.8%
  误差 ≤ 10℃:  85.4%

🎯 目标达成情况:
  误差在5℃以内的样本比例: 59.8%

✅ 成功! 平均MAE达到4.94℃，低于5℃目标!


改进的地方，主要应该是对高温采取了重点处理，更针对性的处理，然后其他的优化器，特征也增强了一下，现在的话最小是4.03，平均是4.94
1. 温度感知的数据增强
效果：针对性增强，高温区域使用更强增强来模拟更多噪声和变化。
2. 改进的数据预处理
效果：高温图像使用更强的高光去除和去噪，更符合实际场景。
3. 温度平衡的数据划分
效果：确保每个温度点在训练集和测试集中都有合理分布，防止某些温度过度拟合。
4. 增强的特征提取
效果：更丰富的特征表示，包括多尺度信息和温度统计特征。
5. 温度感知模型架构
效果：模型可以针对高温区域进行专门的调整。
6. 加权损失函数
效果：给高温样本更高权重，强制模型更关注高温区域的准确性。
7. 改进的优化器和调度
效果：更现代的优化器和调度策略。