# 镁合金热成像温度预测系统 🔥

## 📋 项目简介

基于深度学习的**热成像温度预测系统**，专门为镁合金工业应用设计。通过分析红外热成像图像的Lab色彩空间特征和多尺度统计特征，采用**温度感知的ResNet混合架构**实现高精度温度回归预测。

**目标**：在250-450°C温度范围内实现MAE < 5°C的预测精度，特别强化高温区域(>400°C)的准确性。

---

## 🏗️ 核心架构

### TemperatureAwareResNet - 温度感知神经网络

```
输入：(RGB图像, 多尺度直方图特征, 温度提示)
      ↓
┌─────────────────────────────────────────────┐
│                 CNN分支                      │
├─────────────────────────────────────────────┤
│ ResNet18 (ImageNet预训练)                   │
│ → 特征提取: [512, 7, 7]                     │
│ → SE注意力机制（通道权重）                   │
│ → 全局平均池化: 512维特征                    │
└─────────────────────────────────────────────┘
      ↓
┌─────────────────────────────────────────────┐
│              统计特征分支                     │
├─────────────────────────────────────────────┤
│ 输入：(基础统计8维 + 多尺度直方图)          │
│ → Linear(特征维→128) → ReLU → BatchNorm    │
│ → Dropout(0.2) → Linear(128→64)            │
│ → 64维融合特征                              │
└─────────────────────────────────────────────┘
      ↓
    [拼接] → (512 + 64 = 576维)
      ↓
┌─────────────────────────────────────────────┐
│           温度感知回归头                     │
├─────────────────────────────────────────────┤
│ 576 → Linear(256) → ReLU → BatchNorm       │
│     → Linear(128) → ReLU → BatchNorm       │
│     → Linear(64) → ReLU → Linear(1)        │
└─────────────────────────────────────────────┘
      ↓
   高温补偿层 (仅>400°C样本)
      ↓
    预测温度值
```

**关键组件**：
- **ResNet18基础**：预训练权重快速收敛，高效特征提取
- **SE注意力块**：Squeeze-Excitation机制，动态增强/抑制关键通道
- **多尺度直方图**：16/32/48-bin分辨率捕捉颜色分布的多粒度信息
- **高温补偿层**：额外的温度调整模块，针对>400°C高温样本优化

---

## 🖼️ 数据预处理流程

### 1️⃣ Lab色彩空间转换

```
原始图像(RGB) → Lab色彩空间
  ├─ L通道：亮度（0-255）
  ├─ a通道：绿-红色度（通常-127~127）
  └─ b通道：蓝-黄色度（通常-127~127）
```

### 2️⃣ 温度自适应预处理

**高光去除** (处理反光）：
- 检测：L > 中位数 + 70×(1.0 + 温度偏离量×0.5)
- 修复：中值滤波替换高亮像素

**亮度对齐**：
- 目标亮度 = 128.0 - (T - 中心温度) / 范围 × 10
- 自适应调整确保不同温度图像的亮度一致性

**自适应降噪**：
- 低温(<350°C)：3×3高斯核
- 高温(≥350°C)：5×5高斯核

**对比度增强** (仅高温>400°C)：
- CLAHE (Contrast Limited Adaptive Histogram Equalization)
- clipLimit=2.0, tileGridSize=(8,8)

### 3️⃣ 多尺度特征提取

**颜色直方图**（192维）：
```python
for bins in [16, 32, 48]:
    hist_a = cv2.calcHist(a, bins) → 归一化
    hist_b = cv2.calcHist(b, bins) → 归一化
```

**统计特征**（8维）：
- 温度归一化 (T/100.0)
- a通道：mean, std
- b通道：mean, std  
- L通道：mean, std
- L中位数

**总特征维度**：200维 = 192维直方图 + 8维统计

---

## 🎓 数据标准化

```
标准化：label = (T - center_temp) / half_range
        其中 center_temp = (250 + 450) / 2 = 350°C
             half_range = (450 - 250) / 2 = 100°C

反标准化：T_pred = output × 100 + 350
```

范围映射：250-450°C → [-1, 1]

---

## 📊 训练配置

### 数据增强策略（温度感知）

**高温区域** (>400°C) - 更强增强：
```
RandomHorizontalFlip(p=0.5)
RandomVerticalFlip(p=0.5)
RandomRotation(±15°)
ColorJitter(brightness=0.15, contrast=0.15)
```

**中低温** (≤400°C) - 温和增强：
```
RandomHorizontalFlip(p=0.3)
RandomRotation(±10°)
```

**通用变换**：
```
Resize(240→224随机裁剪)
```

### 数据集分割

- **训练集**：80% + 数据增强
- **测试集**：20% + 无增强
- **温度平衡**：每个温度点按80/20比例分割
- **批大小**：16

### 损失函数 - WeightedHuberLoss

```python
基础Huber损失：
  if |δ| < Δ: loss = 0.5 × δ²
  else:       loss = Δ × (|δ| - 0.5×Δ)

权重加强（>400°C样本 × 1.5）：
  weighted_loss = loss × weight
  其中 weight = 1.0 (低温) 或 2.5 (高温)
```

**参数**：
- delta = 1.0（Huber阈值）
- high_temp_weight = 1.5（高温加权系数）

### 优化配置

| 参数 | 值 |
|------|-----|
| 优化器 | AdamW |
| 学习率 | 0.0003 |
| Weight Decay | 1e-4 |
| 学习率调度 | OneCycleLR |
| 峰值学习率 | 0.001 |
| 开始下降点 | 30% epoch |
| 梯度裁剪 | max_norm=1.0 |
| **训练轮数** | **200 epochs** |

---

## 🔄 训练流程

```
初始化 → 数据加载(train/test分割)
  ↓
[每个Epoch]:
  ┌─ 训练阶段 ─────────────────────────────────┐
  │ FOR batch IN train_loader:                 │
  │   • 前向传播(CNN + 统计特征 → 温度预测)    │
  │   • 计算加权Huber损失                      │
  │   • 反向传播                               │
  │   • 梯度裁剪(max_norm=1.0)                 │
  │   • 权重更新 + LR步进                      │
  └────────────────────────────────────────────┘
  ↓
  ┌─ 测试评估 ─────────────────────────────────┐
  │ • 总体MAE（所有样本）                       │
  │ • 高温MAE (>400°C)                         │
  │ • 低温MAE (≤400°C)                         │
  │ • 保存最佳模型(基于总体MAE)                 │
  └────────────────────────────────────────────┘
  ↓
最后 → 加载最佳模型 → 重新生成完整测试集预测
    → 生成6面板可视化分析图表
```

---

## 📈 可视化分析 (detailed_analysis)

训练完成后自动生成`final_results.png`（6面板）：

| 面板 | 说明 |
|------|------|
| **训练损失** | 200个epoch的损失曲线，监控收敛 |
| **测试MAE对比** | 总体/高温/低温三条线 + 5°C目标 |
| **预测vs真实** | 散点图(颜色编码温度) + 完美拟合线 |
| **误差分布** | 直方图，展示残差正态性 |
| **绝对误差CDF** | 累积分布函数 + 百分位标注 |
| **温度vs误差** | 散点图 + 20点移动平均趋势线 |

---

## 🎯 性能指标

目标：**MAE < 5°C**

输出统计：
```
• 平均绝对误差 (MAE)：℃
• 均方根误差 (RMSE)：℃
• 分温度区间的MAE
• 误差≤5°C的样本占比
```

---

## 📁 文件说明

| 文件 | 说明 |
|------|------|
| `main03.py` | 🔴 **主训练脚本**（完整流程） |
| `predict.py` | 推理脚本，对新图像预测温度 |
| `ttransform.py` | 文件重命名工具（数据预处理） |
| `best_model_mae_*.pth` | 不同MAE的模型检查点 |
| `optimized_final_model.pth` | 最终优化模型 |
| `final_results.png` | 6面板分析图表 |

---

## 🖥️ 系统需求

```
硬件：NVIDIA GPU + CUDA
软件：
  • Python 3.7+
  • PyTorch 1.9+ (with CUDA)
  • OpenCV (cv2)
  • PIL/Pillow
  • NumPy
  • Matplotlib
```

---

## 🚀 使用方法

### 训练

```bash
python main03.py
```

自动流程：
1. 数据加载 + 温度平衡分割
2. 200轮训练（最优模型自动保存）
3. 基于最佳模型的完整测试集预测
4. 生成分析报告 + 6面板可视化

### 推理

```bash
python predict.py --image path/to/image.jpg
```

---

## 📝 核心创新

1. **Lab色彩空间**：红外图像更适合Lab而非RGB
2. **温度感知预处理**：不同温度区间采用不同的增强/去噪策略
3. **多尺度特征**：16/32/48-bin直方图捕捉多粒度颜色信息
4. **加权损失**：高温样本1.5倍权重，聚焦困难样本
5. **SE注意力**：通道级权重自适应，动态特征重新加权
6. **高温补偿层**：额外的>400°C温度调整模块
7. **双轨评估**：分别评估高/低温性能，精细化诊断

---

## 📊 数据格式要求

图像文件命名规范：
```
prefix_TEMPERATURE_suffixext
示例：sample_385.5_img1.jpg  → T=385.5°C
```

目录结构：
```
非均匀分组/
  ├── image_250.0_1.jpg
  ├── image_280.5_2.jpg
  ├── image_450.0_n.jpg
  └── ...
```

## 环境要求

```
Python 3.7+
PyTorch >= 1.7.0
OpenCV (cv2)
NumPy
Matplotlib
torchvision
```

## 使用方法

### 1. 数据准备
- 将镁合金图像放置在指定目录
- 文件名格式：`G{组号}_{温度}.jpg`，例如：`G3_350.jpg`（G3组，350°C）
- 修改 main03.py 中的 `data_dir` 为实际路径

### 2. 运行训练
```bash
python main03.py
```

### 3. 进行预测
```bash
python predict.py
```
修改文件中的模型路径和输入图像路径

## 模型性能

- 训练数据：镁合金高温氧化图像
- 输出范围：250°C - 450°C
- 评估指标：MAE（平均绝对误差，单位°C）

============================================================
🏁 训练完成
   用时: 70分 19秒
   最终最佳测试 MAE: 4.03℃

💾 模型已保存到: optimized_final_model.pth

============================================================
📊 最终结果详细分析
============================================================

🎯 总体指标:
  平均绝对误差 (MAE): 4.94℃
  均方根误差 (RMSE): 6.54℃

🌡️  分温度区间:
  低温(250-300℃): 20样本, MAE:  5.94℃, STD:  5.05℃
  中低温(300-350℃): 20样本, MAE:  2.15℃, STD:  2.96℃
  中温(350-400℃): 20样本, MAE:  2.99℃, STD:  3.24℃
  高温(400-450℃): 20样本, MAE:  7.66℃, STD:  4.30℃

📈 误差分布分析:
  误差 ≤ 1℃:  24.4%
  误差 ≤ 2℃:  36.6%
  误差 ≤ 3℃:  42.7%
  误差 ≤ 4℃:  50.0%
  误差 ≤ 5℃:  59.8%
  误差 ≤ 10℃:  85.4%

🎯 目标达成情况:
  误差在5℃以内的样本比例: 59.8%

✅ 成功! 平均MAE达到4.94℃，低于5℃目标!


改进的地方，主要应该是对高温采取了重点处理，更针对性的处理，然后其他的优化器，特征也增强了一下，现在的话最小是4.03，平均是4.94
1. 温度感知的数据增强
效果：针对性增强，高温区域使用更强增强来模拟更多噪声和变化。
2. 改进的数据预处理
效果：高温图像使用更强的高光去除和去噪，更符合实际场景。
3. 温度平衡的数据划分
效果：确保每个温度点在训练集和测试集中都有合理分布，防止某些温度过度拟合。
4. 增强的特征提取
效果：更丰富的特征表示，包括多尺度信息和温度统计特征。
5. 温度感知模型架构
效果：模型可以针对高温区域进行专门的调整。
6. 加权损失函数
效果：给高温样本更高权重，强制模型更关注高温区域的准确性。
7. 改进的优化器和调度
效果：更现代的优化器和调度策略。